## Test 17: Memory Leak Check [1 pts]

```

if ! ( which valgrind &> /dev/null ); then
    # "valgrind is not installed. Please install (as root) with:"
    # "pacman -Sy valgrind"
    test_end 1
fi

leak_output=$(timeout 10 valgrind \
    --trace-children=no \
    --child-silent-after-fork=yes \
    --leak-check=full \
    --track-fds=yes \
    --show-leak-kinds=all \
    --track-origins=yes \
    ./$SHELL_NAME < <(echo "${script}") 2>&1)

echo "${leak_output}"
==3047699== Memcheck, a memory error detector
==3047699== Copyright (C) 2002-2022, and GNU GPL'd, by Julian Seward et al.
==3047699== Using Valgrind-3.20.0 and LibVEX; rerun with -h for copyright info
==3047699== Command: ./shshsh
==3047699== 
shshsh.c:190:main(): Input command: ls /
bin
boot
bootstrap.sh
dev
etc
home
lib
lib64
mnt
opt
proc
root
run
sbin
srv
sys
tmp
usr
var
shshsh.c:190:main(): Input command: !1
bin
boot
bootstrap.sh
dev
etc
home
lib
lib64
mnt
opt
proc
root
run
sbin
srv
sys
tmp
usr
var
shshsh.c:190:main(): Input command: 
shshsh.c:190:main(): Input command: 
shshsh.c:190:main(): Input command: jobs
exec: No such file or directory
shshsh.c:190:main(): Input command: cd
==3047699== Syscall param chdir(path) points to unaddressable byte(s)
==3047699==    at 0x4A942AB: chdir (syscall-template.S:120)
==3047699==    by 0x10A068: main (shshsh.c:259)
==3047699==  Address 0x0 is not stack'd, malloc'd or (recently) free'd
==3047699== 
shshsh.c:190:main(): Input command: ls / # Doing some more lsing
bin
boot
bootstrap.sh
dev
etc
home
lib
lib64
mnt
opt
proc
root
run
sbin
srv
sys
tmp
usr
var
shshsh.c:190:main(): Input command: !!
bin
boot
bootstrap.sh
dev
etc
home
lib
lib64
mnt
opt
proc
root
run
sbin
srv
sys
tmp
usr
var
shshsh.c:190:main(): Input command: asdfghjklqprewopiqwualasdf # Bad Command!
exec: No such file or directory
shshsh.c:190:main(): Input command: # Comment only
shshsh.c:190:main(): Input command: pwd
/home/skuan/first-day/P3-marcus0329
shshsh.c:190:main(): Input command: echo hi
hi
shshsh.c:190:main(): Input command: sort -r -n < /etc/passwd > /tmp/9186
sort: cannot read: '<': No such file or directory
shshsh.c:190:main(): Input command: rm /tmp/9186
rm: cannot remove '/tmp/9186': No such file or directory
shshsh.c:190:main(): Input command: history
shshsh.c:190:main(): Input command: !p
shshsh.c:190:main(): Input command: 
shshsh.c:190:main(): Input command: 
shshsh.c:190:main(): Input command: echo bye
bye
getline: Inappropriate ioctl for device
1 ls /
2 !1
3 
4 
5 jobs
6 cd
7 ls / # Doing some more lsing
8 !!
9 asdfghjklqprewopiqwualasdf # Bad Command!
10 # Comment only
11 pwd
12 echo hi
13 sort -r -n < /etc/passwd > /tmp/9186
14 rm /tmp/9186
15 history
==3047699== 
==3047699== FILE DESCRIPTORS: 9 open (3 std) at exit.
==3047699== Open file descriptor 63:
==3047699==    <inherited from parent>
==3047699== 
==3047699== Open file descriptor 23: /dev/pts/ptmx
==3047699==    <inherited from parent>
==3047699== 
==3047699== Open file descriptor 22: /dev/pts/ptmx
==3047699==    <inherited from parent>
==3047699== 
==3047699== Open file descriptor 21: /home/skuan/.local/share/code-server/logs/20230124T153642/remoteagent.log
==3047699==    <inherited from parent>
==3047699== 
==3047699== Open file descriptor 20: /dev/pts/ptmx
==3047699==    <inherited from parent>
==3047699== 
==3047699== Open file descriptor 19: /home/skuan/.local/share/code-server/logs/20230124T153642/ptyhost.log
==3047699==    <inherited from parent>
==3047699== 
==3047699== 
==3047699== HEAP SUMMARY:
==3047699==     in use at exit: 2,536 bytes in 20 blocks
==3047699==   total heap usage: 64 allocs, 44 frees, 62,304 bytes allocated
==3047699== 
==3047699== 256 bytes in 1 blocks are definitely lost in loss record 1 of 2
==3047699==    at 0x4841888: malloc (vg_replace_malloc.c:393)
==3047699==    by 0x1099E9: main (shshsh.c:147)
==3047699== 
==3047699== 2,280 bytes in 19 blocks are definitely lost in loss record 2 of 2
==3047699==    at 0x4841888: malloc (vg_replace_malloc.c:393)
==3047699==    by 0x4A0EE2E: getdelim (iogetdelim.c:65)
==3047699==    by 0x1096F7: readinput (shshsh.c:38)
==3047699==    by 0x109B94: main (shshsh.c:179)
==3047699== 
==3047699== LEAK SUMMARY:
==3047699==    definitely lost: 2,536 bytes in 20 blocks
==3047699==    indirectly lost: 0 bytes in 0 blocks
==3047699==      possibly lost: 0 bytes in 0 blocks
==3047699==    still reachable: 0 bytes in 0 blocks
==3047699==         suppressed: 0 bytes in 0 blocks
==3047699== 
==3047699== For lists of detected and suppressed errors, rerun with: -s
==3047699== ERROR SUMMARY: 3 errors from 3 contexts (suppressed: 0 from 0)

# Check for open FDs
awk "${fd_check}" <<< "${leak_output}" \
    | grep -i '==[0-9]*==.*file descriptor' && test_end 1

# Make sure there were no leaks possible
grep -i '==[0-9]*==.*no leaks are possible' \
    <<< "${leak_output}" || test_end 1
 --> Test failed (1)
```

